(function($){$.fn.autocomplete=function(options){var o=$.extend({},$.fn.autocomplete.defaults,options);if(typeof options=='string'){this.each(function(){var that=$(this);if(options=='destroy'){that.off('blur.autocomplete focus.autocomplete keydown.autocomplete keyup.autocomplete');if(that.data('autocomplete'))
that.attr('autocomplete',that.data('autocomplete'));else
that.removeAttr('autocomplete');$(that.data('sc')).remove();that.removeData('sc').removeData('autocomplete');}});return this;}
return this.each(function(){var that=$(this);that.sc=$('<div class="autosuggestions"></div>');that.data('sc',that.sc).data('autocomplete',that.attr('autocomplete'));that.attr('autocomplete','off');that.cache={};that.last_val='';that.offset=0;that.hide=function(){that.offset=0;that.sc.hide();if($.isFunction(o.onHide))o.onHide();}
that.show=function(){that.offset=0;that.sc.show();if($.isFunction(o.onShow))o.onShow();}
that.sc.appendTo(o.appendTo);that.sc.on('mouseleave','.autosuggestion',function(){$('.autosuggestion.selected').removeClass('selected');});that.sc.on('mouseenter','.autosuggestion',function(){$('.autosuggestion.selected').removeClass('selected');$(this).addClass('selected');});that.sc.on('mousedown click','button, i',function(e){e.stopPropagation();var t=$(this).is('i')?$(this).parent():$(this);if(t.is(':enabled')){var suggestion=$(this).closest('.autosuggestion');$.featherlight(suggestion.data('link')+'?tocart',{width:980});}});that.sc.on('mousedown click','.autosuggestion',function(e){var item=$(this),v=item.data('val');if(v||val.hasClass('autosuggestion')){that.val(v);o.onSelect(e,v,item);that.hide();}
return false;});that.on('blur.autocomplete',function(){try{over_sb=$('.autosuggestions:hover').length;}catch(e){over_sb=0;}
if(!over_sb){that.last_val=that.val();var hide;hide=that.hide();if(hide)setTimeout(function(){that.sc.hide();},350);}else if(!that.is(':focus'))setTimeout(function(){that.focus();},20);});if(!o.minChars)that.on('focus.autocomplete',function(){that.last_val='\n';that.trigger('keyup.autocomplete');});that.endOfContent=false;that.sc.on('scroll',function(e){if(!that.endOfContent&&$(this).scrollTop()+$(this).innerHeight()>=$(this)[0].scrollHeight){$('body').css('cursor','wait');get(that.val(),add);}});function get(search,response){$.ajax({url:o.source,dataType:o.dataType,cache:o.cache,context:that,data:{query:search,offset:that.offset,limit:o.limit+1,decount:o.decount},success:function(data){response(data);},complete:function(){$('body').css('cursor','');}})}
function add(data){var val=that.val();if(data.length){var s='';for(var i=0;i<data.length;i++){that.offset++;s+=o.renderItem(data[i],val);}
that.sc.append(s);}else{that.endOfContent=true;}}
function suggest(data){var val=that.val();that.cache[val]=data;if(data.length&&val.length>=o.minChars){var s='';for(var i=0;i<data.length;i++){if(data[i].data.count)that.offset++;s+=o.renderItem(data[i],val);}
that.sc.html(s);that.show();}
else{that.hide();}}
that.on('keydown.autocomplete',function(e){if((e.which==40||e.which==38)&&that.sc.html()){var next,sel=$('.autosuggestion.selected',that.sc);if(!sel.length){next=(e.which==40)?$('.autosuggestion',that.sc).first():$('.autosuggestion',that.sc).last();that.val(next.addClass('selected').data('val'));}else{next=(e.which==40)?sel.next('.autosuggestion'):sel.prev('.autosuggestion');if(next.length){sel.removeClass('selected');that.val(next.addClass('selected').data('val'));}
else{sel.removeClass('selected');that.val(that.last_val);next=0;}}
that.show();return false;}
else if(e.which==27)that.val(that.last_val).sc.hide();else if(e.which==13||e.which==9){var sel=$('.autosuggestion.selected',that.sc);if(sel.length&&that.sc.is(':visible')){o.onSelect(e,sel.data('val'),sel);setTimeout(function(){that.hide();},20);}}});that.on('keyup.autocomplete',function(e){if(!~$.inArray(e.which,[13,27,35,36,37,38,39,40])){var val=that.val();if(val.length>=o.minChars){if(val!=that.last_val){that.last_val=val;clearTimeout(that.timer);if(o.cache){if(val in that.cache){that.offset=0;suggest(that.cache[val]);return;}
for(var i=1;i<val.length-o.minChars;i++){var part=val.slice(0,val.length-i);if(part in that.cache&&!that.cache[part].length){suggest([]);return;}}}
that.timer=setTimeout(function(){that.offset=0;get(val,suggest)},o.delay);}}else{that.last_val=val;that.hide();}}});});$('.autosuggestion').on({'mousenter':function(){$(this).addClass('selected');},'mouseleave':function(){$(this).removeClass('selected');}});}
$.fn.autocomplete.defaults={source:0,dataType:'json',decount:'',limit:8,minChars:3,delay:150,cache:true,};}(jQuery));